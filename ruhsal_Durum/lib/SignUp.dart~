import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:ruhsal_durum/Login.dart';

class Signup extends StatefulWidget {
  const Signup({super.key});

  @override
  State<Signup> createState() => _SignupState();
}

class _SignupState extends State<Signup> {
  final TextEditingController _namecontroller=TextEditingController();
  final TextEditingController _surnamecontroller=TextEditingController();
  final TextEditingController _phonecontroller=TextEditingController();
  final TextEditingController _emailcontroller=TextEditingController();
  final TextEditingController _passwordcontroller=TextEditingController();
  bool _obscureText = false;
  bool kontrol=false;
  Future<bool> Kaydet()
  async {
    setState(() {
      kontrol=true;
    });
    try{
      UserCredential userCredential = await FirebaseAuth.instance.createUserWithEmailAndPassword(
        email: _emailcontroller.text.trim(),
        password: _passwordcontroller.text.trim(),
      );
  await FirebaseFirestore.instance
      .collection("users")
      .doc(userCredential.user!.uid)
      .set({
         'name':_namecontroller.text,
         'surname':_surnamecontroller.text,
         'phone':_phonecontroller.text,
         'email':_emailcontroller.text
         });
     return true;
    }on FirebaseAuthException catch (e) {
      String errorMessage;
      switch (e.code) {
        case 'weak-password':
          errorMessage = 'Şifre çok zayıf. Daha güçlü bir şifre giriniz.';
          break;
        case 'email-already-in-use':
          errorMessage = 'Bu e-posta adresi zaten kullanımda.';
          break;
        case 'invalid-email':
          errorMessage = 'Geçersiz e-posta adresi.';
          break;
        default:
          errorMessage = 'Bir hata oluştu: tekrar deneyin';
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(errorMessage)),
      );
      return false;
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Beklenmeyen bir hata oluştu: $e')),
      );
      return false;
    }
    finally{
      setState(() {
        kontrol=false;
      });
    }
  }

  void kayit_basarili() {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("Kayıt başarılı! Giriş yapabilirsiniz.")),
    );

    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (context) => LoginPage()),
    );
  }

  @override
  Widget build(BuildContext context) {
    return  Scaffold(
      backgroundColor: Colors.grey,
        body: SingleChildScrollView(
          child: Column(
            children: [
              const SizedBox(height: 150,),
              const Icon(Icons.assignment_ind,size: 50,color:Colors.black38),
             const SizedBox(height: 30,),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 10),
                child: Card(
                  elevation: 4,
                  shape:RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15)
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 15,),
                    child: TextField(
                      style: GoogleFonts.alef(),
                      controller: _namecontroller,
                      decoration: const InputDecoration(
                          hintText: "isim alanı",
                          border: InputBorder.none
                      ),
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 15,),
          
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 10),
                child: Card(
                  elevation: 5,
                  shape:RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15)
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 15,),
                    child: TextField(
                      style: GoogleFonts.alef(),
                      controller: _surnamecontroller,
                      decoration: const InputDecoration(
                          hintText: "soyisim alanı",
          
                          border: InputBorder.none
          
                      ),
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 15,),
          
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 10),
                child: Card(
                  elevation: 5,
                  shape:RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15)
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 15,),
                    child: TextField(
                      style: GoogleFonts.alef(),
                      controller: _phonecontroller,
                      keyboardType: TextInputType.number,
                      inputFormatters: [
                        FilteringTextInputFormatter.digitsOnly,
                        LengthLimitingTextInputFormatter(10)
                      ],
                      decoration: const InputDecoration(
                          hintText: "500 000 00 00 ",
                          prefixText: "+90 ",
                          border: InputBorder.none,
          
                      ),
          
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 15,),
          
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 10),
                child: Card(
                  elevation: 5,
                  shape:RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15)
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 15,),
                    child: TextField(
                      style: GoogleFonts.alef(),
                      controller: _emailcontroller,
                      keyboardType: TextInputType.emailAddress,
                      decoration: InputDecoration(
          
                          hintText: "email alanı",
                          border: InputBorder.none
          
                      ),
                    ),
                  ),
          
                )
              ),
              const SizedBox(height: 15,),
          
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 10),
                child: Card(
                  elevation: 5,
                  shape:RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15)
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 15,),
                    child: TextFormField(
                      style: GoogleFonts.alef(),
                      controller: _passwordcontroller,
                      obscureText:  _obscureText,
                      decoration: InputDecoration(
                          hintText: "şifre alanı",
                          border: InputBorder.none,
                         suffixIcon: IconButton(onPressed: (){
                           setState(() {
                             if(_obscureText==false) _obscureText=true;
                             else{
                               _obscureText=false;
                             }
                           });
          
                           }, icon:  Icon( _obscureText ? Icons.visibility_off : Icons.visibility,))
                      ), 
                        
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 15,),
             Row(
               mainAxisAlignment: MainAxisAlignment.spaceEvenly,
               children: [
               ElevatedButton(onPressed: kontrol ?null: ()  async  {
                 bool succes = await Kaydet();
                 if(succes==true){
                   kayit_basarili();
                 }
               }, child: Text("KAYDET",style: GoogleFonts.montserrat(textStyle: TextStyle(color: Colors.white),)),style: ElevatedButton.styleFrom(
                 padding: const EdgeInsets.symmetric(horizontal: 40,vertical: 15),
                 shape: RoundedRectangleBorder(
                   borderRadius: BorderRadius.circular(15),
                 ),
                 backgroundColor: Colors.black12,

               ),),


               ElevatedButton(onPressed:() {
                 Navigator.push(context, MaterialPageRoute(builder: (context)=>LoginPage()));
               }, child: Text("GERİ ÇIK",style: GoogleFonts.montserrat(textStyle: TextStyle(color: Colors.white),)),style: ElevatedButton.styleFrom(
                 padding: const EdgeInsets.symmetric(horizontal: 40,vertical: 15),
                 shape: RoundedRectangleBorder(
                   borderRadius: BorderRadius.circular(15),
                 ),
                 backgroundColor: Colors.black12,

               ),),

             ],),

            ],
          ),
        ),

    );
  }
}
